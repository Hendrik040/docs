---
title: 'Quick Reference'
description: 'Common patterns, flows, and commands at a glance'
icon: 'book-bookmark'
---

## Core Workflows

### PDF to Simulation Pipeline

```mermaid
sequenceDiagram
    participant Prof as Professor
    participant FE as Frontend
    participant API as API Gateway
    participant PDF as pdf_processing
    participant LP as LlamaParse
    participant GPT as OpenAI
    participant DB as Database

    Prof->>FE: Upload PDF
    FE->>API: POST /api/parse-pdf/upload
    API->>PDF: Process PDF
    PDF->>LP: Extract text
    LP-->>PDF: Structured content
    PDF->>GPT: Extract metadata & personas
    GPT-->>PDF: Scenario data
    PDF->>GPT: Generate scenes
    GPT-->>PDF: Scene descriptions
    PDF->>GPT: Create images (DALL-E)
    GPT-->>PDF: Image URLs
    PDF->>DB: Save scenario
    DB-->>PDF: Scenario ID
    PDF-->>API: Success
    API-->>FE: Scenario ready
    FE-->>Prof: Preview
```

### Student Simulation Flow

```mermaid
sequenceDiagram
    participant S as Student
    participant FE as Frontend
    participant API as API Gateway
    participant Sim as simulation
    participant Agent as PersonaAgent
    participant GPT as OpenAI
    participant DB as Database

    S->>FE: Start simulation
    FE->>API: POST /api/simulation/start
    API->>Sim: start_simulation()
    Sim->>DB: Load scenario + create progress
    DB-->>Sim: Data
    Sim-->>API: Success
    API-->>FE: Ready
    
    loop Chat
        S->>FE: Send message
        FE->>API: POST /api/simulation/linear-chat
        API->>Sim: process_message()
        Sim->>DB: Get history
        Sim->>Agent: generate_response()
        Agent->>GPT: AI call
        GPT-->>Agent: Response
        Sim->>DB: Save conversation
        Sim-->>API: Message
        API-->>FE: Display
    end
```

## Backend Structure

<CodeGroup>

```plaintext Directory Structure
backend/
├── app/                    # FastAPI wiring
│   ├── main.py            # Entry point
│   ├── dependencies.py    # DI providers
│   └── middleware.py      # CORS, auth
│
├── modules/               # Feature modules
│   ├── simulation/
│   ├── pdf_processing/
│   ├── auth/
│   ├── professor/
│   └── student/
│
├── common/                # Shared infrastructure
│   ├── config.py         # Settings
│   ├── db/               # Database
│   └── utils/            # Helpers
│
└── agents/               # AI agents
    ├── persona_agent.py
    ├── grading_agent.py
    └── summarization_agent.py
```

```python Module Pattern
modules/<feature>/
├── router.py         # HTTP endpoints
├── service.py        # Business logic
├── repository.py     # Data access
└── schemas/          # Pydantic models
```

</CodeGroup>

## Key Endpoints

<Tabs>
  <Tab title="Authentication">
    ```bash
    POST   /users/register             # Register new user
    POST   /users/login                # Login (email/password)
    GET    /api/auth/google            # Google OAuth
    GET    /api/auth/google/callback   # OAuth callback
    POST   /users/logout               # Logout
    GET    /users/me                   # Current user
    ```
  </Tab>
  
  <Tab title="PDF Processing">
    ```bash
    POST   /api/parse-pdf/upload       # Upload PDF
    GET    /api/parse-pdf/progress/{session_id}  # Progress
    WS     /ws/pdf-progress/{session_id}         # WebSocket updates
    ```
  </Tab>
  
  <Tab title="Simulation">
    ```bash
    POST   /api/simulation/start       # Start simulation
    POST   /api/simulation/linear-chat # Send message
    GET    /api/simulation/progress    # Get progress
    ```
  </Tab>
  
  <Tab title="Professor">
    ```bash
    GET    /api/professor/cohorts      # List cohorts
    POST   /api/professor/cohorts      # Create cohort
    POST   /api/professor/invitations  # Send invitations
    GET    /api/professor/grading      # Get grading materials
    ```
  </Tab>
  
  <Tab title="Student">
    ```bash
    GET    /api/student/simulation-instances  # List simulations
    POST   /api/student/simulation-instances  # Start simulation
    GET    /api/student/cohorts                # List cohorts
    ```
  </Tab>
</Tabs>

## Common Commands

<AccordionGroup>
  <Accordion title="Development">
    ```bash Backend
    cd backend
    source venv/bin/activate  # Activate venv
    uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
    ```

    ```bash Frontend
    cd frontend
    npm run dev  # or pnpm dev
    ```

    ```bash Database
    cd backend/database
    alembic upgrade head  # Run migrations
    alembic revision --autogenerate -m "message"  # Create migration
    ```
  </Accordion>

  <Accordion title="Docker">
    ```bash
    # Start services
    docker-compose up -d

    # View logs
    docker-compose logs -f postgres redis

    # Stop services
    docker-compose down

    # Reset database
    docker-compose down -v  # Removes volumes
    docker-compose up -d
    ```
  </Accordion>

  <Accordion title="Testing">
    ```bash
    # Run all tests
    pytest

    # Run specific module
    pytest tests/modules/simulation/

    # Run with coverage
    pytest --cov=modules --cov-report=html
    ```
  </Accordion>
</AccordionGroup>

## Environment Variables

<CodeGroup>

```bash Required
DATABASE_URL=postgresql://user:pass@host:5432/dbname
OPENAI_API_KEY=sk-...
SECRET_KEY=your-secret-key-32-chars-minimum
```

```bash Optional
REDIS_URL=redis://localhost:6379
ANTHROPIC_API_KEY=sk-...
LLAMAPARSE_API_KEY=llx-...
GOOGLE_CLIENT_ID=...
GOOGLE_CLIENT_SECRET=...
GOOGLE_REDIRECT_URI=http://localhost:3000/auth/google/callback
```

```bash AWS/Wasabi Storage
# AWS
AWS_ACCESS_KEY_ID=...
AWS_SECRET_ACCESS_KEY=...
AWS_BUCKET_NAME=...
AWS_REGION=us-east-1

# OR Wasabi
WASABI_ACCESS_KEY_ID=...
WASABI_SECRET_ACCESS_KEY=...
WASABI_BUCKET_NAME=...
WASABI_ENDPOINT_URL=https://s3.wasabisys.com
```

</CodeGroup>

## Database Schema (Core Tables)

```sql
-- Users
users (id, user_id, email, role, password_hash, ...)

-- Scenarios
scenarios (id, unique_id, title, description, created_by, ...)

-- Personas
scenario_personas (id, scenario_id, name, role, personality_traits, ...)

-- Scenes
scenario_scenes (id, scenario_id, title, description, scene_order, ...)

-- Progress
user_progress (id, user_id, scenario_id, current_scene_id, status, ...)

-- Conversations
conversation_logs (id, user_progress_id, scene_id, message_content, ...)

-- Cohorts
cohorts (id, name, professor_id, scenario_id, ...)
cohort_memberships (id, cohort_id, student_id, status, ...)
cohort_invitations (id, cohort_id, email, invitation_token, ...)

-- Notifications
notifications (id, user_id, type, message, is_read, ...)
```

## Cache Strategy

<CardGroup cols={2}>
  <Card title="AI Response Cache" icon="brain">
    **TTL**: 1 hour
    
    Caches OpenAI API responses
    
    `ai_cache:{hash}`
  </Card>
  
  <Card title="Database Query Cache" icon="database">
    **TTL**: 5 minutes
    
    Caches frequent DB queries
    
    `db_cache:scenarios:{user_id}`
  </Card>
  
  <Card title="Session Cache" icon="user">
    **TTL**: 30 minutes
    
    User session data
    
    `session:{user_id}`
  </Card>
  
  <Card title="Scenario Cache" icon="book">
    **TTL**: 15 minutes
    
    Scenario data with personas
    
    `scenario:{scenario_id}`
  </Card>
</CardGroup>

## Error Codes

| Code | Meaning | Description |
|------|---------|-------------|
| `400` | Bad Request | Invalid input data |
| `401` | Unauthorized | No or invalid token |
| `403` | Forbidden | No permission |
| `404` | Not Found | Resource doesn't exist |
| `409` | Conflict | Duplicate resource |
| `422` | Unprocessable Entity | Validation failed |
| `500` | Internal Server Error | Server issue |

## Development Patterns

### Dependency Injection

```python
@router.post("/start")
async def start_simulation(
    request: SimulationStartRequest,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    repository = SimulationRepository(db)
    service = SimulationService(repository)
    return await service.start_simulation(request, current_user.id)
```

### Error Handling

```python
# Service raises domain exceptions
if not scenario:
    raise KeyError(scenario_id)

# Router converts to HTTP exceptions
try:
    result = service.start_simulation(...)
except KeyError as e:
    raise HTTPException(404, f"Scenario {e} not found")
```

### Repository Pattern

```python
class SimulationRepository:
    def __init__(self, db: Session):
        self.db = db
    
    def get_scenario(self, scenario_id: int) -> Optional[Scenario]:
        return self.db.query(Scenario).filter_by(id=scenario_id).first()
```

## Troubleshooting

<AccordionGroup>
  <Accordion title="Could not validate credentials">
    1. Check cookie is set: `/debug/cookie-status`
    2. Verify token is valid and not expired
    3. Clear cookies and login again
  </Accordion>

  <Accordion title="Database connection errors">
    1. Check `DATABASE_URL` in `.env`
    2. Verify PostgreSQL is running: `docker-compose ps postgres`
    3. Test connection: `psql $DATABASE_URL`
  </Accordion>

  <Accordion title="Redis connection errors">
    1. Check `REDIS_URL` in `.env`
    2. Verify Redis is running: `docker-compose ps redis`
    3. App continues without Redis (degraded mode)
  </Accordion>

  <Accordion title="PDF processing stuck">
    1. Check WebSocket connection: Browser DevTools → Network
    2. Verify `LLAMAPARSE_API_KEY` is set
    3. Check logs for API errors
  </Accordion>
</AccordionGroup>

## Useful Links

<CardGroup cols={2}>
  <Card title="API Docs" icon="code" href="http://localhost:8000/docs">
    Interactive FastAPI documentation
  </Card>
  
  <Card title="Frontend" icon="window" href="http://localhost:3000">
    Next.js application
  </Card>
  
  <Card title="Architecture" icon="sitemap" href="/architecture/overview">
    Detailed system design
  </Card>
  
  <Card title="Developer Guide" icon="book" href="/development/getting-started">
    Development patterns
  </Card>
</CardGroup>

<Check>
  **Pro Tip**: Bookmark this page for quick access to common commands and patterns!
</Check>

